---
title: "Toolchain SpeechRecorder — MAUS — EMU-SDMS"
author: "Markus Jochim"
date: "October 2017"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(emuR)
```

Most phonetic research projects involve this workflow:

1. Record speech
1. Annotate speech using automatic tools
1. Check and correct the generated annotations by hand
1. Analyze speech (connecting the primary data with annotations and derived signals)

The EMU Speech Database Management System is focused on steps 3 and 4 of this workflow. For the first two steps, it can very usefully be complemented by two other tools: SpeechRecorder and MAUS. This chapter introduces two ways how the three tools can be combined in a systematic way.

## What do SpeechRecorder and MAUS do?

“SpeechRecorder is a platform independent audio recording software customized to the requirements of speech recordings (http://www.speechrecorder.org/).” To this end, SpeechRecorder lets you define prompts that participants will read (or otherwise react to) while you are recording them. At the end of a session, instead of one large recording of the whole session, you have a set of smaller audio recordings, each one representing a single prompt.

MAUS (Munich AUtomatic Segmentation) and particularly WebMAUS is a software service that processes audio recordings with corresponding orthographic transcriptions, and outputs (1) a corresponding phonetic transcription and (2) a segmentation of the signal into individual speech sounds.

## Combining the tools

The order in which the three tools are used is fixed, since the files first have to be recorded, then annotated and then analyzed. However, there are different ways of passing data between the tools. For example SpeechRecorder might *export* files into emuDB format or the EMU-SDMS might *import* files stored in SpeechRecorder’s format (note that MAUS does not store files). After all, the three are separate tools and can be used individually (although the combination makes great sense). We suggest two ways of combining them.

### Combining the tools with intermediary text files

SpeechRecorder can be configured to save, along with each audio recording, a text file containing the orthographic transcription. This is great because it is exactly what MAUS needs as its input. This remains very easy as long as the prompts are text prompts (and not images or other media) and the prompts are indeed what the participants say. If the prompts are questions that participants have to answer, it does not work in a straightforward way because SpeechRecorder does not know the orthographic transcription.

In order for SpeechRecorder to produce the desired result, configure your project in the following way (note that parts of its user interface are in German):

- Under “Projekt / Einstellungen... / Annotation”:
  - Under “Persist”, tick the checkbox that says “Simple text loader writer for annotation template for MAUS processing”
  - Under “Auto annotation”, tick the checkbox that says “Prompt template auto annotator”
- In your script (if you edit the XML file directly): Make sure each of your ```<mediaitem>``` elements has the attribute ```annotationTemplate="true"```
- In your script (if you create using the graphical interface): Make sure to tick the checkbox “Use as annotation template” for *every recording*.

Now, after your recording session, you will have audio and text files. These files could now be processed by uploading them on the [BAS web site](https://clarin.phonetik.uni-muenchen.de/BASWebServices/#!/services/Pipeline), but we recommend a way that is easier and more systematic (especially if MAUS is used repeatedly). It can be done using emuR. In emuR, the combination of .wav and .txt files is called a *txt collection*. We will thus use the function ```convert_txtCollection```, to import SpeechRecorder’s files into Emu’s format, like this:

```{r eval=F}

convert_txtCollection(dbName = "myNewDatabase",
                      sourceDir = "~/speechrecorder/myProject/RECS/",
                      targetDir = "~/EMU-Databases/")

db = load_emuDB("~/EMU-Databases/myNewDatabase_emuDB/")
```

Afterwards, we make use of several of emuR’s functions called ```runBASwebservice_...```. They will upload the data to WebMAUS and incorporate the results directly into your files (this of course takes some time, depending on the size of your database and the speed of your internet connection).

```{r eval=F}
runBASwebservice_g2pForTokenization(db,
                                    "transcription",
                                    "deu-DE",
                                    "Word")

runBASwebservice_g2pForPronunciation(db,
                                     "Word",
                                     "deu-DE",
                                     "Canonical")

runBASwebservice_maus(db,
                      "Canonical",
                      "deu-DE",
                      "Phonetic")
```

When the services are finished, we can use
```{r eval=F}
serve(db)
```
to inspect the database with the new annotations.

### Combining the tools without intermediary files

The previous section showed you how to 